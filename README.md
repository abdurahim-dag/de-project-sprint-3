# Проект 3-го спринта

### Описание
Репозиторий предназначен для сдачи проекта 3-го спринта

### Как работать с репозиторием
1. В вашем GitHub-аккаунте автоматически создастся репозиторий `de-project-sprint-3` после того, как вы привяжете свой GitHub-аккаунт на Платформе.
2. Скопируйте репозиторий на свой локальный компьютер, в качестве пароля укажите ваш `Access Token` (получить нужно на странице [Personal Access Tokens](https://github.com/settings/tokens)):
	* `git clone https://github.com/{{ username }}/de-project-sprint-3.git`
3. Перейдите в директорию с проектом: 
	* `cd de-project-sprint-3`
4. Выполните проект и сохраните получившийся код в локальном репозитории:
	* `git add .`
	* `git commit -m 'my best commit'`
5. Обновите репозиторий в вашем GutHub-аккаунте:
	* `git push origin main`

### Структура репозитория
1. Папка `migrations` хранит файлы миграции. Файлы миграции должны быть с расширением `.sql` и содержать SQL-скрипт обновления базы данных.
2. В папке `src` хранятся все необходимые исходники: 
    * Папка `dags` содержит DAG's Airflow.

### Как запустить контейнер
Запустите локально команду:

```
docker run -d --rm -p 3000:3000 -p 15432:5432 --name=de-project-sprint-3-server sindb/project-sprint-3:latest
```

После того как запустится контейнер, у вас будут доступны:
1. Visual Studio Code
2. Airflow
3. Database


# Проект

В этом проекте вы потренируетесь изменять процессы в пайплайне так, чтобы они соответствовали новым задачам бизнеса. Мы разделили задание на три этапа развития пайплайна — вы будете постепенно дорабатывать его, получая новые вводные от заказчика.
В итоге должен получится код, который включает в себя решения для каждой ситуации. Мы положили эталонный пайплайн в Docker-контейнер — примерно такой, какой должен был получиться у вас в конце этого спринта. Вы можете доработать его или написать все самостоятельно.

## Этап 1

Пайплайн, который вы сделали в этом спринте, работает, и ваши коллеги уже успешно им пользуются. На данных из витрины `mart.f_sales` BI-аналитики построили графики `total revenue` для различных срезов. Система магазина продолжает развиваться: команда разработки добавила функционал отмены заказов и возврата средств (`refunded`). Значит, процессы в пайплайне нужно обновить.

### **Исходные данные**

Новые инкременты с информацией о продажах приходят по API, спецификация к которому лежит ниже, и содержат статус заказа (`shipped` /`refunded`).

***

### **Спецификация API**

**POST /generate_report** Метод `/generate_report` инициализирует формирование отчёта. В заголовке запроса нужно указать:

* `X-Nickname` — ваш никнейм (например, sashanikonov).
* `X-Project` со значением `True` — так мы узнаем, что вы выполняете итоговый проект.
* `X-Cohort` со значением номера вашей когорты (например, 1).
* `X-API-KEY` со значением `5f55e6c0-e9e5-4a9c-b313-63c01fc31460`. Если не указать верный ключ к API, то вместо ожидаемого результата выйдет ошибка доступа.

Установите предварительно утилиту curl, чтобы с помощью неё обратиться к API. Выполните следующие команды в командной строке:JSON

```
curl --location --request POST 'https://d5dg1j9kt695d30blp03.apigw.yandexcloud.net/generate_report' \
--header 'X-Nickname: {{ your_nickname }}' \
--header 'X-Cohort: {{ your_cohort_number }}' \
--header 'X-Project: True' \
--header 'X-API-KEY: {{ api_key }}' \
--data-raw ''
```

В качестве переменных, указанных в `{{ }}`, передайте ваши актуальные данные. Метод возвращает `task_id` — ID задачи, в результате выполнения которой должен сформироваться отчёт. **GET /get_report** Метод `get_report` используется для получения отчёта после того, как он будет сформирован на сервере. С помощью утилиты curl обратитесь к API:JSON

```
curl --location --request GET 'https://d5dg1j9kt695d30blp03.apigw.yandexcloud.net/get_report?task_id={{ task_id }}' \
--header 'X-Nickname: {{ your_nickname }}' \
--header 'X-Cohort: {{ your_cohort_number }}' \
--header 'X-Project: True' \
--header 'X-API-KEY: {{ api_key }}'
```

Пока отчёт будет формироваться, будет возвращаться статус `RUNNING`. Если отчёт сформирован, то метод вернёт статус `SUCCESS` и `report_id`. Сформированный отчёт содержит четыре файла:

* `custom_research.csv`,
* `user_orders_log.csv`,
* `user_activity_log.csv`,
* `price_log.csv`.

Файлы отчетов можно получить по URL из параметра `s3_path` или сформировать URL самостоятельно по следующему шаблону:JSON

```
https://storage.yandexcloud.net/s3-sprint3/cohort_{{ your_cohort_number }}/{{ your_nickname }}/project/{{ report_id }}/{{ file_name }}
```

**GET /get_increment** Метод `get_increment` используется для получения данных за те даты, которые не вошли в основной отчёт. Дата обязательно в формате `2020-01-22T00:00:00`. С помощью утилиты curl обратитесь к API:JSON

```
curl --location --request GET 'https://d5dg1j9kt695d30blp03.apigw.yandexcloud.net/get_increment?report_id={{ report_id }}&date={{ date }}' \
--header 'X-Nickname: {{ your_nickname }}' \
--header 'X-Cohort: {{ your_cohort_number }}' \
--header 'X-Project: True' \
--header 'X-API-KEY: {{ api_key }}'
```

Если инкремент сформирован, то метод вернёт статус `SUCCESS` и `increment_id`. Если инкремент не сформируется, то вернётся `NOT FOUND` с описанием причины. Сформированный инкремент содержит три файла:
• `custom_research_inc.csv`,
• `user_orders_log_inc.csv`,
• `user_activity_log_inc.csv`,
• `price_log_inc.csv`. Файлы отчетов можно получить по URL из параметра `s3_path` или сформировать URL самостоятельно по следующему шаблону:JSON

```
https://storage.yandexcloud.net/s3-sprint3/cohort_{{ your_cohort_number }}/{{ your_nickname }}/project/{{ increment_id }}/{{ file_name }}
```

***

### **Ваша задача**

Адаптируйте ваш пайплайн для текущей задачи:

* Учтите в витрине `mart.f_sales` статусы `shipped` и `refunded`. Все данные в витрине следует считать `shipped`.
* Обновите пайплайн с учётом статусов иbackward compatibility.

**Подсказки:**

1. Необходимо провести миграцию схемы и данных в таблице `mart.f_sales`.
2. Таблица фактов `mart.f_sales` должна приобрести вид транзакционной таблицы фактов. Будьте внимательны со статусом `refunded`.
3. Чтобы `total revenue` правильно рассчитывался, строки с `refunded` добавляйте со знаком `-`.
4. Первый инкремент приходит со старым форматом данных — без статуса заказа. Проверьте, что ваш код правильно проставляет статус в этом случае.

## Этап 2

Ваши коллеги решили лучше изучить поведение клиентов. Для этого они хотят исследовать возвращаемость клиентов, или customer retention. Выяснилось, что на текущий момент отчёт по customer retention строится очень долго. Коллеги попросили вас вычислить нужные метрики в дополнительной витрине. Эта витрина должна отражать следующую информацию:

* Рассматриваемый период — weekly.
* Возвращаемость клиентов:
	- `new` — кол-во клиентов, которые оформили один заказ за рассматриваемый период;
	- `returning` — кол-во клиентов, которые оформили более одного заказа за рассматриваемый период;
	- `refunded` — кол-во клиентов, которые вернули заказ за рассматриваемый период.
* Доход (`revenue`) и `refunded` для каждой категории покупателей.

Благодаря витрине можно будет выяснить, какие категории товаров лучше всего удерживают клиентов. Коллеги подготовили для вас схему витрины `mart.f_customer_retention`:

```
mart.f_customer_retention
mart.f_customer_retention
1. new_customers_count — кол-во новых клиентов (тех, которые сделали только один 
заказ за рассматриваемый промежуток времени).
2. returning_customers_count — кол-во вернувшихся клиентов (тех,
которые сделали только несколько заказов за рассматриваемый промежуток времени).
3. refunded_customer_count — кол-во клиентов, оформивших возврат за 
рассматриваемый промежуток времени.
4. period_name — weekly.
5. period_id — идентификатор периода (номер недели или номер месяца).
6. item_id — идентификатор категории товара.
7. new_customers_revenue — доход с новых клиентов.
8. returning_customers_revenue — доход с вернувшихся клиентов.
9. customers_refunded — количество возвратов клиентов.
```

### **Ваша задача**

На основе пайплайна из сквозной задачи спринта наполните витрину `mart.f_customer_retention` данными по <<возвращаемости клиентов>> в разрезе недель.

## Этап 3 — опционально

📌 Мы примем проект без этого этапа, если предыдущие два сделаны верно. Этот этап для тех, кто любит челлендж и готов разобраться с [идемпотентностью](https://ru.wikipedia.org/wiki/%D0%98%D0%B4%D0%B5%D0%BC%D0%BF%D0%BE%D1%82%D0%B5%D0%BD%D1%82%D0%BD%D0%BE%D1%81%D1%82%D1%8C). В понедельник вы пришли на работу, проверили систему мониторинга и не нашли никаких неполадок. Однако коллеги-разработчики сообщили, что из-за бага в бэкенде данные из источника за воскресенье пришли неполные. Баг починили, данные инкремента восстановили, и теперь вам нужно сделать так, чтобы данные в аналитической системе отражали реальную картину.

### **Ваша задача**

* Перезапустить пайплайн и убедиться, что после перезапуска не появилось дубликатов в витринах `mart.f_sales` и `mart.f_customer_retention`.

### **Источники данных**

Получить новый инкремент можно по API, используя метод `GET /get_increment`. **Подсказка:** Проверьте, что каждый этап пайплайна учитывает удаление предыдущих данных за расчётный период.